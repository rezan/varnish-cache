varnishtest "VCL_SUB_LAZY wrong vmod behavior"

varnish v1 -arg "-p feature=+no_coredump" -vcl {
	import debug;

	backend dummy None;

	sub foo {
		set resp.http.it = "works";
	}

	sub vcl_init {
		debug.store_call_lazy(foo);
	}
} -start

varnish v1 -vcl {
	import debug;
	backend dummy None;

	sub vcl_recv {
		debug.call_lazy(debug.total_recall());
	}

}

client c1 {
	txreq -url "/foo"
	expect_close
} -run

varnish v1 -cliexpect "Assert error in VRT_check_call" "panic.show"
varnish v1 -cliok "panic.clear"
varnish v1 -expectexit 0x40
